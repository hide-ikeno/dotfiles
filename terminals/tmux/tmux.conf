##
## ~/.tmux.conf
##
## The configuration file for Terminal MUltipleXer (tmux)
##

#
# NOTE:
#
#   | command           | alias  |
#   |-------------------+--------|
#   | set-option        | set    |
#   | set-window-option | setw   |
#   | bind-key          | bind   |
#   | unbind-key        | unbind |
#   | if-shell          | if     |
#   | run-shell         | run    |
#

#=============================
# General settings
#=============================

# Prefix key --- <C-Space> [default: <C-b>]
set-option -g  prefix C-Space
unbind-key C-b
# map prefix + prefix to send prefix key to terminal
bind-key   C-Space send-prefix

# Default termtype. If $TERM is set, the value is overwritten.
set-option -g  default-terminal "screen-256color"
# True Color
set-option -ga terminal-overrides ",xterm-256color:Tc"
# set-option the number of paste buffer (default: 20)
set-option -g  buffer-limit 50
# Maximum number of lines held in window history (default: 2000)
set-option -g  history-limit 10000

# Escape time in milliseconds (default: 500)
set-option -sg escape-time 0
# Update 'status-left' and 'status-right' every 5 second [default: 15]
set-option -g  status-interval 5
# Display time in milliseconds (default: 750)
set-option -g  display-time 5000
# Display time for the indicator in milliseconds (default: 1000)
set-option -g  display-panes-time 5000

# Enable mouse support
set-option -g  mouse on

# Start index of window/pane with 1 (default: 0)
set-option        -g base-index 1
set-window-option -g pane-base-index 1
# Reset window number when a window is closed.
set-option        -g renumber-windows on
# Disable automatic window renaming
set-window-option -g allow-rename off
# Aggressive window resize
set-window-option -g aggressive-resize on

# # support logging out and back in
# set -g update-environment "SSH_ASKPASS SSH_AUTH_SOCK SSH_AGENT_PID_SSH_CONNECTION"

#=============================
# Keybindings
#=============================

# Use emacs-like keybindings in tmux command prompt (prefix + :)
set-option -g status-keys emacs
# Use vi-like keybindings in copy mode
set-window-option -g mode-keys vi


# Unbind default keybinds, which are goint to be overritten.
unbind-key %    # split-window -h
unbind-key '"'  # split-window
unbind-key [    # copy-mode
unbind-key ]    # paste-buffer
unbind-key "'"  # select-window
unbind-key n    # next-window
unbind-key p    # previous-window

# Reload the tmux configuration file
bind-key C-r source-file ~/.config/tmux/tmux.conf \;\
  display "[tmux] tmux.conf reloaded!"

# Split panes
bind-key | split-window -h -c "#{pane_current_path}" # horizontal
bind-key - split-window -v -c "#{pane_current_path}" # vertical

# Select windows (prev: 'M-S-[', next: 'M-S-]')
bind-key -n M-{ previous-window
bind-key -n M-} next-window

# Select panse (prev: 'M-[', next: 'M-]')
bind-key -n M-[ select-pane -t :.-
bind-key -n M-] select-pane -t :.+

# Move panes
bind-key -n M-h select-pane -L
bind-key -n M-j select-pane -D
bind-key -n M-k select-pane -U
bind-key -n M-l select-pane -R

# Resize pane
bind-key -n M-H resize-pane -L 2
bind-key -n M-J resize-pane -D 2
bind-key -n M-K resize-pane -U 2
bind-key -n M-L resize-pane -R 2

# for Mac OSX (make pbcopy/pbpaste and Vim's * register work.)
if-shell -b 'command -v reattach-to-user-namespace > /dev/null 2>&1' \
  'set-option -g default-command "reattach-to-user-namespace -l $SHELL";'

# prefix + space to enter copy mode
bind-key Space copy-mode
# prefix + p to paste selection
bind-key p     paste-buffer

# --- Keybindings in copy-mode-vi
# unbind default bindings
unbind-key -T copy-mode-vi Enter  # send-keys -X copy-selection-and-cancel

# prefix + v to begin selection
bind-key -T copy-mode-vi  v send-keys -X begin-selection

yank="~/.config/tmux/clipboard-copy.sh"
# prefix + y: copy selected region
bind-key -T copy-mode-vi  y send-keys -X copy-pipe-and-cancel "$yank"
# prefix + Y: copy current line
bind-key -T copy-mode-vi  Y send-keys -X copy-line \;\
  run "tmux save-buffer - | $yank"
# prefix + D: copy from the cursor position to end of line
bind-key -T copy-mode-vi  D send-keys -X copy-end-of-line \;\
  run "tmux save-buffer - | $yank"
# prefix + A: append the selected region to clipboard
bind-key -T copy-mode-vi  A send-keys -X append-selection-and-cancel \;\
  run "tmux save-buffer - | $yank"

# Copy selection on drag end event, but do not cancel copy mode and do not clear selection
# clear select on subsequence mouse click
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe "$yank"
bind -T copy-mode-vi MouseDown1Pane select-pane \; send-keys -X clear-selection

# When scrolling with mouse wheel, reduce number of scrolled rows per tick to
# "2" [default: 5 rows per tick].
bind-key -T copy-mode-vi WheelUpPane   select-pane \; send-keys -X -N 2 scroll-up
bind-key -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 2 scroll-down

#=============================
# Appearance
#=============================
# icons
icon_attr="#[nobold,nounderscore,noitalics]"
divider_left="${icon_attr}"
subdivider_left="${icon_attr}"
divider_right="${icon_attr}"
subdivider_right="${icon_attr}"
clock_icon=""
session_icon="❐"
host_icon=""

# --- Window mode
set-option -g mode-style    "fg=default,bg=magenta"

# --- Command line (message)
set-option -g message-style "fg=black,bg=brightyellow"

# --- Window status
set-window-option -g window-status-separator ""

win_separator0="#[fg=black,bg=black]$divider_left"
win_separator1="#[fg=black,bg=cyan]$divider_left"
win_separator2="#[fg=cyan,bg=black]$divider_left"
set-window-option -g window-status-format \
  "$win_separator0#[fg=white,bg=black] #I $subdivider_left #W $win_separator0"
set-window-option -g window-status-current-format \
  "$win_separator1#[fg=brightwhite,bg=cyan,bold] #I $subdivider_left #W $win_separator2"

# style for windows with activity alert
set-window-option -g window-status-activity-style "fg=yellow"

# --- Pane border
set-window-option -g pane-border-style        "fg=white"
set-window-option -g pane-active-border-style "fg=white"

set-option -g display-panes-colour        "brightblue"
set-option -g display-panes-active-colour "brightyellow"

# --- Status line
set-option -g status on
set-option -g status-position top
set-option -g status-justify  left
set-option -g status-left-length  100
set-option -g status-right-length 100

set-option -g status-style "fg=brightblack,bg=black"

# left status line
status_separator_fg="#{?client_prefix,#[fg=brightblue],#{?pane_in_mode,#{?selection_present,#[fg=magenta],#[fg=yellow]},}}$divider_left"
status_separator_bg="#{?client_prefix,#[bg=brightblue],#{?pane_in_mode,#{?selection_present,#[bg=magenta],#[bg=yellow]},}}$divider_left"
status_mode="#[fg=black]#[bg=green]#{?client_prefix,#[bg=brightblue] PREFIX ,#{?pane_in_mode,#{?selection_present,#[bg=magenta] VISUAL ,#[bg=yellow] COPY }, DEFAULT }}"
widget_session="#[fg=black,bg=brightwhite,bold]#{?client_readonly,#[fg=white]#[bg=red],} $session_icon #S #[fg=brightwhite,bg=green]#{?client_readonly,#[fg=red],}$status_separator_bg"
widget_tmux_status="${status_mode}#[fg=green]#[bg=black]$status_separator_fg"
set-option -g status-left "${widget_session}${widget_tmux_status}"

# Right status line
# widget_sysstat="#(tmux-mem-cpu-load --colors --interval 5 --cpu-mode 0 --mem-mode 2 --graph-lines 5)"
# widget_separator="#[fg=white,bg=black,nobold,nounderscore,noitalics]$subdivider_right"
# widget_sysstat="$widget_separator #{sysstat_cpu} $widget_separator #{sysstat_mem} $widget_separator #{sysstat_swap}"
widget_time="#[fg=brightblack,bg=black]${divider_right}#[fg=white,bg=brightblack] ${clock_icon} %Y-%m-%d %H:%M"
widget_host="#[fg=green,bg=brightblack]${divider_right}#[fg=black,bg=green] ${host_icon} #h"
widget_right_end="#[fg=brightyellow,bg=green]${divider_right}#[fg=red,bg=yellow]${divider_right}"
set-option -g status-right "${widget_time} ${widget_host} ${widget_right_end}"

# # Right status line from powerline
# run-shell "powerline-daemon -q"
# if-shell 'env "$POWERLINE_CONFIG_COMMAND" tmux setup' '' 'run-shell "powerline-config tmux setup"'

#============================
# Plugins
#============================
# # Location of Tmux plugin
# set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.config/tmux/plugins'
# # List of plugins
# set-option -g @tpm_plugins '            \
#     tmux-plugins/tpm                    \
#     tmux-plugins/tmux-battery           \
#     tmux-plugins/tmux-open              \
#     tmux-plugins/tmux-prefix-highlight  \
#     samoshkin/tmux-plugin-sysstat       \
# '
#
# # Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
# run-shell '~/.config/tmux/plugins/tpm/tpm'
